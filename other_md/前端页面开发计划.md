## 📐 整体架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    前端 (Vue 3)                         │
├─────────────────────────────────────────────────────────┤
│  登录页  │  分块调试页  │  对话页  │  文档管理页      │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP API
┌─────────────────▼───────────────────────────────────────┐
│              后端 (FastAPI / Flask)                      │
├─────────────────────────────────────────────────────────┤
│  认证模块  │  分块预览  │  向量存储  │  RAG 问答      │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│             核心模块（已完成）                           │
├─────────────────────────────────────────────────────────┤
│  PDF Loader  │  SemanticChunker  │  Chroma  │  LLM    │
└─────────────────────────────────────────────────────────┘
```

---

## 🗂️ 功能模块拆解

### 后端 API 设计（FastAPI 推荐）

#### 1. 认证模块
```
POST /api/auth/login        # 登录
POST /api/auth/logout       # 登出
GET  /api/auth/user         # 获取当前用户信息
```

#### 2. 分块预览模块（核心！）
```
POST /api/chunk/preview           # 上传PDF，返回分块预览
  - 请求: PDF文件 + 分块参数（chunk_size, threshold等）
  - 响应: 分块结果 + 元数据（不存入正式库）

GET  /api/chunk/similarity-curve  # 获取相邻块语义相似度曲线
  - 请求: 分块会话ID
  - 响应: {indices: [0,1,2...], similarities: [0.85, 0.72, ...]}

POST /api/chunk/test-retrieval    # 测试召回效果
  - 请求: 测试问题 + 分块会话ID
  - 响应: 召回的分块列表

POST /api/chunk/confirm           # 确认分块，正式存入 Chroma
  - 请求: 分块会话ID
  - 响应: 成功/失败

DELETE /api/chunk/session/:id     # 取消分块，清理临时数据
```

#### 3. 文档管理模块
```
GET    /api/documents              # 获取所有文档列表
DELETE /api/documents/:name        # 删除指定文档（从Chroma删除）
GET    /api/documents/stats        # 获取统计信息
```

#### 4. 对话模块
```
POST /api/chat/query               # RAG 问答
  - 请求: {question, model, top_k}
  - 响应: {answer, sources, elapsed_time}

GET  /api/chat/models              # 获取可用模型列表
POST /api/chat/switch-model        # 切换模型
```

---

### 前端页面设计（Vue 3）

#### 页面1：登录页
```
/login
- 简单的用户名/密码登录
- JWT Token 存储到 localStorage
```

#### 页面2：分块调试页（重点！）
```
/chunking

┌────────────────────────────────────────────────────┐
│  📄 文档分块调试                                   │
├────────────────────────────────────────────────────┤
│                                                    │
│  [1] 上传 PDF                                      │
│      ┌──────────────────────────┐                 │
│      │  拖拽或点击上传 PDF       │                 │
│      └──────────────────────────┘                 │
│                                                    │
│  [2] 分块参数配置                                  │
│      ┌────────────┬────────────┬────────────┐    │
│      │ Chunk Size │  Overlap   │ Threshold  │    │
│      │    300     │    0.1     │    0.8     │    │
│      └────────────┴────────────┴────────────┘    │
│                                                    │
│      ☑ 启用动态阈值                                │
│      滑动窗口: [2]                                 │
│                                                    │
│      [开始预览分块]                                │
│                                                    │
│  [3] 分块结果预览                                  │
│      ┌────────────────────────────────────────┐  │
│      │ 📊 共生成 23 个分块                     │  │
│      │                                         │  │
│      │ 分块1  (第1页, 285字符)                 │  │
│      │ 深度学习是机器学习的一个分支...          │  │
│      │                                         │  │
│      │ 分块2  (第1页, 312字符)                 │  │
│      │ 神经网络由多层节点组成...                │  │
│      │                                         │  │
│      │ ...                                     │  │
│      └────────────────────────────────────────┘  │
│                                                    │
│  [4] 语义相似度曲线                                │
│      ┌────────────────────────────────────────┐  │
│      │ 1.0 ┤                                   │  │
│      │ 0.9 ┤   ●─●                            │  │
│      │ 0.8 ┤ ●─●   ●─●                        │  │
│      │ 0.7 ┤         ●   ●                    │  │
│      │ 0.6 ┤             ●─●─●                │  │
│      │     └────────────────────────────────  │  │
│      │      块1  块5  块10  块15  块20         │  │
│      └────────────────────────────────────────┘  │
│                                                    │
│  [5] 召回测试                                      │
│      问题: [劳动合同期限是多久？]  [测试]         │
│                                                    │
│      召回结果 (Top 3):                             │
│      ✓ 分块5 - 相似度: 0.89                       │
│      ✓ 分块12 - 相似度: 0.76                      │
│      ✓ 分块8 - 相似度: 0.71                       │
│                                                    │
│  [6] 操作                                          │
│      [✓ 确认提交到正式库]  [↻ 重新调整参数]       │
└────────────────────────────────────────────────────┘
```

#### 页面3：对话页
```
/chat

┌────────────────────────────────────────────────────┐
│  💬 RAG 智能问答                                   │
├────────────────────────────────────────────────────┤
│  当前模型: [DeepSeek ▼]                           │
│  检索数量: [5]                                     │
├────────────────────────────────────────────────────┤
│                                                    │
│  User: 劳动合同期限是多久？                        │
│                                                    │
│  Assistant: 根据劳动合同，合同期限为3年...         │
│  📚 来源: 劳动合同.pdf (第1页) - 相似度: 0.89     │
│                                                    │
│  User: 工作地点在哪里？                            │
│                                                    │
│  Assistant: 工作地点位于...                        │
│  📚 来源: 劳动合同.pdf (第2页) - 相似度: 0.85     │
│                                                    │
├────────────────────────────────────────────────────┤
│  [输入您的问题...]                    [发送]       │
└────────────────────────────────────────────────────┘
```

---

## 🔑 关键技术点

### 1. 分块会话管理（临时存储）
```python
# 后端需要维护临时会话
sessions = {
    "session_abc123": {
        "file_name": "test.pdf",
        "documents": [...],  # 分块结果
        "embeddings": [...], # 向量（用于召回测试）
        "similarities": [...],  # 相似度数据
        "created_at": "2024-01-15 10:00:00",
        "expires_at": "2024-01-15 12:00:00"  # 2小时后过期
    }
}
```

### 2. 语义相似度曲线数据
```python
# 返回给前端用于绘图
{
    "indices": [0, 1, 2, 3, 4, 5, ...],
    "similarities": [0.85, 0.72, 0.88, 0.65, ...]
}
```

### 3. 召回测试（不用正式库）
```python
# 在临时向量上做检索
temp_vectorstore = Chroma.from_documents(
    documents=session_documents,
    embedding=embedding,
    collection_name=f"temp_{session_id}"  # 临时集合
)
```

---

## 🚀 技术选型建议

### 后端
**推荐 FastAPI**：
- ✅ 自动生成 API 文档（Swagger）
- ✅ 异步支持（处理长时间任务）
- ✅ WebSocket 支持（实时进度推送）
- ✅ 类型提示（Pydantic）

### 前端
**推荐 Vue 3 + Element Plus**：
- ✅ Element Plus 组件丰富
- ✅ ECharts 做相似度曲线图
- ✅ Axios 做 HTTP 请求

---

## 📅 开发顺序建议

### 第一阶段：后端 API（3-4天）
1. FastAPI 基础框架 + 认证
2. 分块预览 API
3. 临时会话管理
4. 召回测试 API
5. 正式提交 API
6. 对话 API

### 第二阶段：前端页面（3-4天）
1. 登录页 + 路由守卫
2. 分块调试页（重点）
3. 对话页
4. 文档管理页

### 第三阶段：集成测试（1-2天）
1. 端到端测试
2. 优化体验

---

## ❓ 需要确认

1. **后端选 FastAPI 还是 Flask？**（我推荐 FastAPI）
2. **前端 UI 框架？**（Element Plus / Ant Design Vue / Naive UI）
3. **图表库？**（ECharts / Chart.js）
4. **认证方式？**（JWT Token / Session）
5. **部署方式？**（Docker / 传统部署）

---

你觉得这个方案怎么样？有什么要调整的吗？确定后我们开始写后端 API！🚀


1. **后端选 FastAPI 还是 Flask？**（我推荐 FastAPI）
  FastAPI
2. **前端 UI 框架？**（Element Plus / Ant Design Vue / Naive UI）
  Element Plus
3. **图表库？**（ECharts / Chart.js）
  之后再考虑
4. **认证方式？**（JWT Token / Session）
  JWT Token
5. **部署方式？**（Docker / 传统部署）
  之后再考虑
