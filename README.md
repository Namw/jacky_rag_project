# RAG Project API

ä¸€ä¸ªåŸºäº FastAPI çš„**æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰ç³»ç»Ÿ**ï¼Œæ”¯æŒå¤šä¸ªå¤§è¯­è¨€æ¨¡å‹æä¾›å•†ï¼Œå…·å¤‡è¯­ä¹‰ç¼“å­˜ã€ä½¿ç”¨é™é¢ç®¡ç†å’Œå®šæ—¶ä»»åŠ¡è°ƒåº¦ç­‰é«˜çº§åŠŸèƒ½ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸ¤– **å¤šæ¨¡å‹æ”¯æŒ** - æ”¯æŒ DeepSeekã€OpenAIã€Claudeã€é˜¿é‡Œå·´å·´é€šä¹‰åƒé—®ç­‰å¤šä¸ª LLM æä¾›å•†
- ğŸ“š **æ–‡æ¡£ç®¡ç†** - æ”¯æŒä¸Šä¼ å’Œå¤„ç† PDFã€Excel ç­‰å¤šç§æ–‡æ¡£æ ¼å¼
- ğŸ” **å‘é‡æ£€ç´¢** - åŸºäº ChromaDB çš„å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒè¯­ä¹‰ç›¸ä¼¼åº¦æœç´¢
- âš¡ **è¯­ä¹‰ç¼“å­˜** - åŸºäº Redis çš„æ™ºèƒ½ç¼“å­˜ï¼Œå‡å°‘é‡å¤æŸ¥è¯¢çš„ API è°ƒç”¨
- ğŸ“Š **ä½¿ç”¨é™é¢ç®¡ç†** - å†…ç½® API ä½¿ç”¨æ¬¡æ•°å’Œé€Ÿç‡é™åˆ¶
- ğŸ” **èº«ä»½è®¤è¯** - åŸºäº JWT çš„ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- ğŸ”„ **å®šæ—¶ä»»åŠ¡** - APScheduler æ”¯æŒçš„å®šæ—¶æ¸…ç†å’Œç»´æŠ¤ä»»åŠ¡
- ğŸ“– **è‡ªåŠ¨æ–‡æ¡£** - FastAPI å†…ç½®çš„ Swagger/OpenAPI æ–‡æ¡£

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python >= 3.13
- Redisï¼ˆç”¨äºè¯­ä¹‰ç¼“å­˜å’Œä½¿ç”¨é™é¢ç®¡ç†ï¼‰
- å„å¤§æ¨¡å‹æä¾›å•†çš„ API Key

### å®‰è£…

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd jakcy_rag_mcp
```

2. **å®‰è£…ä¾èµ–**
```bash
uv sync
```

3. **é…ç½®ç¯å¢ƒå˜é‡**

å¤åˆ¶ `.env` æ¨¡æ¿æ–‡ä»¶ï¼š
```bash
cp .env_copy .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œæ·»åŠ å¿…è¦çš„ API Keysï¼š
```env
# LLM API Keys
DEEPSEEK_API_KEY=your_deepseek_api_key
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
DASHSCOPE_API_KEY=your_dashscope_api_key

# JWT å¯†é’¥
JWT_SECRET_KEY=your_secret_key

# Redis é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
```

4. **å¯åŠ¨åº”ç”¨**

**å¼€å‘ç¯å¢ƒï¼ˆå¸¦è‡ªåŠ¨é‡è½½ï¼‰**
```bash
uv run uvicorn main:app --reload --port 8000
```

**ç”Ÿäº§ç¯å¢ƒ**
```bash
uv run uvicorn main:app --port 8000
```

5. **è®¿é—® API æ–‡æ¡£**

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8000/docs`

## é¡¹ç›®ç»“æ„

```
jakcy_rag_mcp/
â”œâ”€â”€ main.py                          # åº”ç”¨å…¥å£
â”œâ”€â”€ pyproject.toml                   # é¡¹ç›®é…ç½®å’Œä¾èµ–å£°æ˜
â”œâ”€â”€ uv.lock                          # é”å®šçš„ä¾èµ–ç‰ˆæœ¬
â”œâ”€â”€ .env_copy                        # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ model_config.py              # æ¨¡å‹é…ç½®ï¼ˆæ”¯æŒçš„ LLM æä¾›å•†ï¼‰
â”‚
â”œâ”€â”€ models/
â”‚   â””â”€â”€ model_factory.py             # æ¨¡å‹å·¥å‚ç±»
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                         # FastAPI è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.py                  # ç”¨æˆ·è®¤è¯å’Œæˆæƒ
â”‚   â”‚   â”œâ”€â”€ chat.py                  # èŠå¤©æ¥å£
â”‚   â”‚   â”œâ”€â”€ documents.py             # æ–‡æ¡£ç®¡ç†æ¥å£
â”‚   â”‚   â”œâ”€â”€ chromadb_lib.py          # å‘é‡åº“ç®¡ç†
â”‚   â”‚   â””â”€â”€ usage_limits.py          # ä½¿ç”¨é™é¢ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                    # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ retrieval_service.py     # æ£€ç´¢å’Œè¯­ä¹‰ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ semantic_cache.py        # è¯­ä¹‰ç›¸ä¼¼åº¦ç¼“å­˜å®ç°
â”‚   â”‚   â”œâ”€â”€ usage_limiter.py         # ä½¿ç”¨é™é¢ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ scheduler_service.py     # å®šæ—¶ä»»åŠ¡è°ƒåº¦
â”‚   â”‚   â””â”€â”€ vector_store_cache.py    # å‘é‡å­˜å‚¨ç¼“å­˜
â”‚   â”‚
â”‚   â”œâ”€â”€ loaders/                     # æ–‡æ¡£åŠ è½½å™¨
â”‚   â”‚   â””â”€â”€ document_loader.py       # PDFã€Excel ç­‰æ ¼å¼çš„åŠ è½½
â”‚   â”‚
â”‚   â”œâ”€â”€ processors/                  # æ–‡æœ¬å¤„ç†
â”‚   â”‚   â””â”€â”€ text_processor.py        # æ–‡æœ¬æ¸…æ´—å’Œé¢„å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ vectorstore/                 # å‘é‡æ•°æ®åº“
â”‚   â”‚   â””â”€â”€ chroma_store.py          # ChromaDB é›†æˆ
â”‚   â”‚
â”‚   â””â”€â”€ tools/                       # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ pdf_handler.py           # PDF å¤„ç†å·¥å…·
â”‚
â””â”€â”€ tests/                           # æµ‹è¯•æ–‡ä»¶
    â”œâ”€â”€ test_rag_pipeline.py         # RAG æµç¨‹æµ‹è¯•
    â”œâ”€â”€ test_usage_limiter.py        # ä½¿ç”¨é™é¢æµ‹è¯•
    â””â”€â”€ check_chroma_02.py           # å‘é‡åº“æ£€æŸ¥
```

## API æ¥å£æ¦‚è§ˆ

### è®¤è¯æ¥å£ (`/auth`)

- `POST /auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /auth/login` - ç”¨æˆ·ç™»å½•
- `POST /auth/refresh` - åˆ·æ–° JWT Token

### æ–‡æ¡£ç®¡ç† (`/documents`)

- `POST /documents/upload` - ä¸Šä¼ æ–‡æ¡£
- `GET /documents/list` - è·å–æ–‡æ¡£åˆ—è¡¨
- `DELETE /documents/{doc_id}` - åˆ é™¤æ–‡æ¡£
- `GET /documents/{doc_id}` - è·å–æ–‡æ¡£è¯¦æƒ…

### èŠå¤©æ¥å£ (`/chat`)

- `POST /chat/query` - å‘é€æŸ¥è¯¢
- `GET /chat/history` - è·å–èŠå¤©å†å²

### å‘é‡åº“ç®¡ç† (`/chromadb`)

- `POST /chromadb/clean` - æ¸…ç†å‘é‡åº“
- `GET /chromadb/status` - è·å–å‘é‡åº“çŠ¶æ€

### ä½¿ç”¨é™é¢ (`/usage-limits`)

- `GET /usage-limits/stats` - è·å–ä½¿ç”¨ç»Ÿè®¡
- `GET /usage-limits/remaining` - è·å–å‰©ä½™é¢åº¦

## æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### è¯­ä¹‰ç¼“å­˜

åº”ç”¨å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–è¯­ä¹‰ç¼“å­˜æœåŠ¡ï¼š
- **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼š0.8ï¼ˆå¯é…ç½®ï¼‰
- **ç¼“å­˜è¿‡æœŸæ—¶é—´**ï¼š5 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- ä½¿ç”¨ Redis å­˜å‚¨ç¼“å­˜æ•°æ®

### ä½¿ç”¨é™é¢ç®¡ç†

æ”¯æŒä¸¤ç§é™åˆ¶æ–¹å¼ï¼š
- **æ¬¡æ•°é™åˆ¶**ï¼šæ¯ç”¨æˆ·çš„ API è°ƒç”¨æ¬¡æ•°
- **é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢çŸ­æ—¶é—´å†…è¿‡å¤šè¯·æ±‚

### æ”¯æŒçš„æ¨¡å‹

| æä¾›å•† | æ¨¡å‹åç§° | ç¯å¢ƒå˜é‡ |
|-------|---------|---------|
| DeepSeek | `deepseek-chat` | `DEEPSEEK_API_KEY` |
| OpenAI | `gpt-3.5-turbo` | `OPENAI_API_KEY` |
| Claude | `claude-3-sonnet-20240229` | `ANTHROPIC_API_KEY` |
| é€šä¹‰åƒé—® | `qwen3-coder-plus` | `DASHSCOPE_API_KEY` |

## å¼€å‘æŒ‡å—

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹å®æ—¶æ—¥å¿—**
```bash
uv run uvicorn main:app --reload --port 8000
```

2. **æŸ¥çœ‹å·²è¿è¡Œçš„ API è¿›ç¨‹**
```bash
lsof -ti:8000
```

3. **æ€æ­»è¿›ç¨‹**
```bash
lsof -ti:8000 | xargs kill -9
```

### æ·»åŠ æ–°çš„ LLM æä¾›å•†

1. åœ¨ `config/model_config.py` ä¸­æ·»åŠ æ¨¡å‹é…ç½®
2. åœ¨ `models/model_factory.py` ä¸­å®ç°æ¨¡å‹å·¥å‚é€»è¾‘
3. æ›´æ–°ç¯å¢ƒå˜é‡æ–‡æ¡£

### æ‰©å±•æ–‡æ¡£å¤„ç†èƒ½åŠ›

åœ¨ `src/loaders/document_loader.py` ä¸­æ·»åŠ æ–°çš„åŠ è½½å™¨

## ä¾èµ–ç®¡ç†

æœ¬é¡¹ç›®ä½¿ç”¨ **uv** ä½œä¸ºåŒ…ç®¡ç†å·¥å…·ï¼Œæ‰€æœ‰ä¾èµ–åœ¨ `pyproject.toml` ä¸­å£°æ˜ï¼š

```bash
# å®‰è£…ä¾èµ–
uv sync

# æ·»åŠ æ–°ä¾èµ–
uv add package-name

# æ›´æ–°ä¾èµ–
uv sync
```

### ä¸»è¦ä¾èµ–

- **FastAPI** - Web æ¡†æ¶
- **LangChain** - LLM é›†æˆæ¡†æ¶
- **ChromaDB** - å‘é‡æ•°æ®åº“
- **Redis** - ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—
- **APScheduler** - å®šæ—¶ä»»åŠ¡è°ƒåº¦
- **Pydantic** - æ•°æ®éªŒè¯
- **PyMuPDF** - PDF å¤„ç†

## æ•…éšœæ’æŸ¥

### Redis è¿æ¥å¤±è´¥

```
âŒ Redis è¿æ¥å¤±è´¥
âš ï¸  è¯­ä¹‰ç¼“å­˜åŠŸèƒ½å°†ä¸å¯ç”¨
```

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ Redis æœåŠ¡å·²å¯åŠ¨
```bash
# macOS (ä½¿ç”¨ Homebrew)
brew services start redis

# Linux
sudo systemctl start redis-server
```

### ç«¯å£è¢«å ç”¨

```
âŒ Address already in use
```

**è§£å†³æ–¹æ¡ˆ**ï¼šæ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£
```bash
# æ€æ­»è¿›ç¨‹
lsof -ti:8000 | xargs kill -9

# æˆ–ä½¿ç”¨ä¸åŒçš„ç«¯å£
uv run uvicorn main:app --port 8001
```

### æ¨¡å‹ API Key ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥ `.env` æ–‡ä»¶ä¸­æ˜¯å¦é…ç½®äº†æ­£ç¡®çš„ API Key

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **è¯­ä¹‰ç¼“å­˜** - å¯ç”¨ç¼“å­˜ä»¥å‡å°‘é‡å¤æŸ¥è¯¢çš„æˆæœ¬
2. **æ‰¹é‡æ“ä½œ** - ä½¿ç”¨æ‰¹é‡æ¥å£å¤„ç†å¤šä¸ªæ–‡æ¡£
3. **å‘é‡åº“æ¸…ç†** - å®šæœŸæ¸…ç†åºŸå¼ƒçš„æ–‡æ¡£å’Œå‘é‡
4. **Redis ç›‘æ§** - ç›‘æ§ Redis å†…å­˜ä½¿ç”¨æƒ…å†µ

## å®‰å…¨å»ºè®®

- ğŸ” **ä¸è¦æäº¤ `.env` æ–‡ä»¶** - ä½¿ç”¨ `.env_copy` ä½œä¸ºæ¨¡æ¿
- ğŸ”‘ **å®šæœŸè½®æ¢ API Key** - å®šæœŸæ›´æ–°å„æœåŠ¡çš„ API Key
- ğŸ›¡ï¸ **å¯ç”¨ HTTPS** - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- ğŸ“ **å®¡è®¡æ—¥å¿—** - è®°å½•æ‰€æœ‰ç”¨æˆ·æ“ä½œ

## éƒ¨ç½²

### ä½¿ç”¨ uv éƒ¨ç½²åˆ°æ–°ç¯å¢ƒ

```bash
# åœ¨æ–°æœåŠ¡å™¨ä¸Š
git clone <repository-url>
cd jakcy_rag_mcp

# å®‰è£…ä¾èµ–ï¼ˆä¼šä½¿ç”¨ uv.lock ç¡®ä¿ç‰ˆæœ¬ä¸€è‡´ï¼‰
uv sync

# é…ç½®ç¯å¢ƒå˜é‡
cp .env_copy .env
# ç¼–è¾‘ .env æ–‡ä»¶

# å¯åŠ¨åº”ç”¨
uv run uvicorn main:app --host 0.0.0.0 --port 8000
```

### Docker éƒ¨ç½²

```dockerfile
FROM python:3.13-slim

WORKDIR /app

# å®‰è£… uv
RUN pip install uv

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# å®‰è£…ä¾èµ–
RUN uv sync

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨åº”ç”¨
CMD ["uv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åˆ›å»º Issue æˆ–è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚
